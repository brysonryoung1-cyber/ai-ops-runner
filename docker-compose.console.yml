# docker-compose.console.yml â€” OpenClaw Console for VPS deployment
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.console.yml up -d --build
#
# Console uses network_mode: host so it can reach hostd at 127.0.0.1:8877 (hostd binds
# 127.0.0.1 only). Console listens on 127.0.0.1:8787. Expose to tailnet via:
#   sudo tailscale serve --bg --https=443 http://127.0.0.1:8787
# NEVER bind console to 0.0.0.0.
#
# Host Executor (hostd): console calls http://127.0.0.1:8877. No SSH.
# Artifacts: read-only mount from host artifacts dir.

services:
  openclaw_console:
    build:
      context: ./apps/openclaw-console
      dockerfile: Dockerfile
    network_mode: host
    environment:
      PORT: "8787"
      HOSTNAME: "127.0.0.1"
      OPENCLAW_CONSOLE_TOKEN: "${OPENCLAW_CONSOLE_TOKEN}"
      OPENCLAW_ADMIN_TOKEN: "${OPENCLAW_ADMIN_TOKEN}"
      OPENCLAW_HOSTD_URL: "http://127.0.0.1:8877"
      AIOPS_HOST: "${AIOPS_HOST}"
      RUNNER_API_URL: "${RUNNER_API_URL:-http://127.0.0.1:8000}"
      AIOPS_USER: "root"
      OPENCLAW_ARTIFACTS_ROOT: "/app/artifacts"
      OPENCLAW_REPO_ROOT: "/app"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=64M
    volumes:
      - console_data:/app/data:rw
      - ./config:/app/config:ro
      - ./docs:/app/docs:ro
      - ./artifacts:/app/artifacts:rw
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8787/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  console_data:
