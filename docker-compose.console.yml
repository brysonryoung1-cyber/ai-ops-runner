# docker-compose.console.yml â€” OpenClaw Console for VPS deployment
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.console.yml up -d --build
#
# Console uses bridge network with extra_hosts so it can reach hostd via host.docker.internal.
# hostd binds 127.0.0.1:8877 only. Expose to tailnet via:
#   sudo tailscale serve --bg --https=443 http://127.0.0.1:8787
# NEVER bind console to 0.0.0.0.
#
# Host Executor (hostd): console calls OPENCLAW_HOSTD_URL (http://host.docker.internal:8877).
# extra_hosts ensures host.docker.internal resolves on Linux (Docker 20.10+).
# Artifacts: read-only mount from host artifacts dir.

services:
  openclaw_console:
    build:
      context: ./apps/openclaw-console
      dockerfile: Dockerfile
      args:
        OPENCLAW_BUILD_SHA: ${OPENCLAW_BUILD_SHA:-unknown}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "127.0.0.1:8787:8787"
    environment:
      PORT: "8787"
      HOSTNAME: "127.0.0.1"
      OPENCLAW_CONSOLE_TOKEN: "${OPENCLAW_CONSOLE_TOKEN}"
      OPENCLAW_ADMIN_TOKEN: "${OPENCLAW_ADMIN_TOKEN}"
      OPENCLAW_HOSTD_URL: "${OPENCLAW_HOSTD_URL:-http://host.docker.internal:8877}"
      AIOPS_HOST: "${AIOPS_HOST}"
      RUNNER_API_URL: "${RUNNER_API_URL:-http://test_runner_api:8000}"
      OPENCLAW_TRUST_TAILSCALE: "${OPENCLAW_TRUST_TAILSCALE:-1}"
      OPENCLAW_BUILD_SHA: "${OPENCLAW_BUILD_SHA:-}"
      OPENCLAW_CANONICAL_URL: "${OPENCLAW_CANONICAL_URL:-}"
      AIOPS_USER: "root"
      OPENCLAW_ARTIFACTS_ROOT: "/app/artifacts"
      OPENCLAW_REPO_ROOT: "/app"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=64M
    volumes:
      - console_data:/app/data:rw
      - ./config:/app/config:ro
      - ./docs:/app/docs:ro
      - ./artifacts:/app/artifacts:rw
      - /var/lib/ai-ops-runner/autopilot:/var/lib/ai-ops-runner/autopilot:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8787/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  console_data:
