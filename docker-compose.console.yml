# docker-compose.console.yml â€” OpenClaw Console for VPS deployment
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.console.yml up -d --build
#
# The console binds to 127.0.0.1:8787 ONLY.
# Expose to tailnet via: sudo tailscale serve --bg --https=443 http://127.0.0.1:8787
# NEVER bind to 0.0.0.0.

services:
  openclaw_console:
    build:
      context: ./apps/openclaw-console
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:8787:3000"
    environment:
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      # Note: inside the container, Next.js binds to 0.0.0.0:3000,
      # but Docker only publishes to 127.0.0.1:8787 on the host.
      # The container is NOT accessible from outside the host.
      OPENCLAW_CONSOLE_TOKEN: "${OPENCLAW_CONSOLE_TOKEN}"
      OPENCLAW_ADMIN_TOKEN: "${OPENCLAW_ADMIN_TOKEN}"
      AIOPS_HOST: "${AIOPS_HOST}"
      RUNNER_API_URL: "${RUNNER_API_URL:-http://test_runner_api:8000}"
      AIOPS_USER: "root"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=64M
    volumes:
      - console_data:/app/data:rw
      - ./config:/app/config:ro
      - ./docs:/app/docs:ro
      - ./artifacts:/app/artifacts:rw
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  console_data:
