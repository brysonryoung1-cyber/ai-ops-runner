{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Codex Review Verdict",
  "description": "Strict schema for Codex review verdicts in ai-ops-runner. meta.codex_cli MUST be a non-null object when meta.simulated is false.",
  "type": "object",
  "required": ["verdict", "blockers", "non_blocking", "tests_run", "meta"],
  "additionalProperties": false,
  "properties": {
    "verdict": {
      "type": "string",
      "enum": ["APPROVED", "BLOCKED"],
      "description": "The review verdict"
    },
    "blockers": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of blocking issues that must be fixed"
    },
    "non_blocking": {
      "type": "array",
      "items": { "type": "string" },
      "description": "List of non-blocking suggestions"
    },
    "tests_run": {
      "type": "string",
      "description": "Summary of tests that were run"
    },
    "meta": {
      "type": "object",
      "description": "Review provenance metadata. codex_cli is REQUIRED (non-null object) when simulated=false.",
      "required": ["since_sha", "to_sha", "generated_at", "review_mode", "simulated"],
      "additionalProperties": false,
      "properties": {
        "since_sha": {
          "type": "string",
          "description": "Start of reviewed commit range"
        },
        "to_sha": {
          "type": "string",
          "description": "End of reviewed commit range"
        },
        "generated_at": {
          "type": "string",
          "description": "ISO 8601 timestamp of verdict generation"
        },
        "review_mode": {
          "type": "string",
          "enum": ["bundle", "packet"],
          "description": "Whether review was single-bundle or per-file packet"
        },
        "simulated": {
          "type": "boolean",
          "description": "true = CODEX_SKIP test mode (NEVER valid for push gate). false = real Codex review."
        },
        "codex_cli": {
          "description": "Codex CLI provenance. REQUIRED as non-null object when simulated=false. Null when simulated=true.",
          "oneOf": [
            {
              "type": "object",
              "required": ["version", "command"],
              "additionalProperties": false,
              "properties": {
                "version": { "type": "string", "minLength": 1 },
                "command": { "type": "string", "minLength": 1 }
              }
            },
            { "type": "null" }
          ]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "simulated": { "const": false } },
            "required": ["simulated"]
          },
          "then": {
            "required": ["codex_cli"],
            "properties": {
              "codex_cli": {
                "type": "object",
                "required": ["version", "command"]
              }
            }
          }
        }
      ]
    }
  }
}
